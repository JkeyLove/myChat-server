<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Title</title>
  </head>

  <body>

  <div id="roomButton">
    <button id="room1" class="room">房间1</button>
  </div>

  <div>
    <button id="create">创建房间</button>
  </div>

  <div>
    <input type="text" id="messageInput" placeholder="输入消息">
    <button id="sendMessage">发送消息</button>
  </div>

  <!-- 显示消息的列表 -->
  <ul id="messageList"></ul>


  </body>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript">


    $(document).ready(function() {
      var socket;
      // 连接 WebSocket 的函数
      function connectWebSocket(roomId) {

        $("#messageList").empty();

        // 在这里替换为你的 WebSocket 服务器地址
        socket = new WebSocket("ws://127.0.0.1:8848/endPoint/"+ roomId +"/ojc");

        // 连接成功时触发
        socket.onopen = function (event) {
          console.log("WebSocket连接已打开");
        };

        // 接收消息时触发
        socket.onmessage = function (event) {
          console.log("收到消息: " + event.data);
          // 处理接收到的消息
          var message = JSON.parse(event.data);
          displayMessage(message.data[0]);
        };

        // 连接关闭时触发
        socket.onclose = function (event) {
          console.log("WebSocket连接已关闭");
        };
      }


      // 添加房间
      $("#create").click(function() {
        // 获取所有具有 room 类的按钮
        var roomButtons = $(".room");

        // 如果有按钮，则获取最后一个按钮的数字部分，否则从1开始
        var numberPart = roomButtons.length > 0 ? parseInt(roomButtons.last().attr("id").substring(4)) + 1 : 1;

        console.log("最后一个id为"+numberPart)
        // 创建一个新按钮，将数字拼接到 "房间" 后面
        var newButton = $(`<button class="room" id="room${numberPart}">`).text(`房间 ${numberPart}`);

        $("#roomButton").append(newButton);

      });

      // 使用事件代理连接websocket
      $(document).on("click", ".room", function () {
        // 获取roomId
        var roomId = $(this).attr("id");
        alert("已进入聊天室"+roomId)
        console.log("获取roomId：" + roomId);
        // 连接websocket
        connectWebSocket(roomId);
      });


      // 发送消息按钮点击事件
      $("#sendMessage").click(function () {
        // 获取消息输入框的值
        var message = $("#messageInput").val();

        // 检查消息是否非空
        if (message.trim() !== "") {
          // 发送消息到WebSocket服务器
          socket.send(message);
          // 清空消息输入框
          $("#messageInput").val("");
        }
      });


      // 显示消息的函数
      function displayMessage(message) {
        var messageList = $("#messageList");
        var listItem = $("<li>").text(`[${message.username}] ${message.content}`);
        messageList.append(listItem);
      }



    });


  </script>



</html>
